<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Mr Ahmed Mansour | بطاقات الكلمات الإنجليزية</title>
  <style>
    :root{
      --primary:#007bff; --accent:#28a745; --bg:#f8f9fa; --card:#fff;
      --text:#343a40; --shadow:0 6px 18px rgba(0,0,0,0.08); --radius:12px;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    body{font-family:"Cairo", "Segoe UI", Tahoma, sans-serif;background:var(--bg);color:var(--text);padding-bottom:90px;direction:rtl}
    header{background:var(--primary);color:#fff;padding:18px;text-align:center;box-shadow:var(--shadow)}
    header h1{font-size:1.6rem}
    header p{opacity:.95;margin-top:6px}
    .container{max-width:1100px;margin:18px auto;padding:0 16px}
    .word-grid{display:grid;gap:18px;grid-template-columns:repeat(auto-fit,minmax(260px,1fr))}
    .card{background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);padding:18px;display:flex;flex-direction:column;justify-content:space-between;min-height:170px;border:2px solid transparent;transition:transform .18s,box-shadow .18s}
    .card:hover{transform:translateY(-6px)}
    .card.active{border-color:var(--accent);background:#e9fff0}
    .main-word-area{cursor:pointer;padding:6px;border-radius:6px}
    .main-word-area h2{font-size:1.2rem;color:var(--primary);direction:ltr;text-align:left;margin-bottom:6px}
    .arabic-meaning{font-weight:700;color:var(--text);font-size:1rem}
    .aux-container{border-top:1px dashed #ddd;padding-top:10px;margin-top:10px;display:flex;flex-direction:column;gap:8px}
    .aux-item{display:flex;justify-content:space-between;align-items:center;padding:8px;border-radius:8px;cursor:pointer;background:transparent;transition:background .12s}
    .aux-item:hover{background:#fafafa}
    .aux-label{font-weight:700;color:#6c757d;direction:rtl;margin-left:8px}
    .aux-word{font-weight:700;direction:ltr}
    .controls-bar{position:fixed;bottom:12px;left:0;right:0;margin:0 auto;max-width:1100px;background:#222;color:#fff;padding:10px;border-radius:12px;display:flex;gap:12px;align-items:center;justify-content:center;z-index:999}
    .controls-bar button, .controls-bar select{padding:10px 14px;border-radius:8px;border:none;font-weight:700;cursor:pointer}
    .controls-bar button#start-all-btn{background:var(--accent);color:#fff}
    .controls-bar button#stop-reading-btn{background:#c82333;color:#fff}
    .controls-bar select{background:#fff;color:#222}
    /* overlay enable audio */
    #enable-audio-overlay{position:fixed;inset:0;background:linear-gradient(0deg,rgba(0,0,0,.45),rgba(0,0,0,.35));display:flex;align-items:center;justify-content:center;z-index:2000}
    #enable-audio-overlay .panel{background:#fff;padding:20px;border-radius:12px;text-align:center;max-width:320px;width:90%}
    #enable-audio-overlay button{background:var(--accent);border:none;color:#fff;padding:12px 18px;border-radius:10px;font-weight:700;cursor:pointer}
    #enable-audio-overlay p{margin:12px 0 6px;color:#333}
    @media(max-width:720px){header h1{font-size:1.3rem}.card{min-height:150px}.controls-bar{flex-direction:column;gap:8px;padding:12px}}
  </style>
</head>
<body>

<header>
  <h1>Mr Ahmed Mansour</h1>
  <p>مجموعة مفردات الوحدة (1 و 2) التفاعلية — اضغط لتشغيل النطق</p>
</header>

<main class="container">
  <div id="word-grid" class="word-grid"></div>
</main>

<div class="controls-bar" role="region" aria-label="controls">
  <label style="color:#fff;font-weight:700;margin-right:8px">سرعة القراءة:</label>
  <select id="speed-control" title="سرعة النطق">
    <option value="0.7">بطيء (0.7x)</option>
    <option value="1.0" selected>عادي (1.0x)</option>
    <option value="1.3">سريع (1.3x)</option>
    <option value="1.5">أسرع (1.5x)</option>
  </select>
  <button id="start-all-btn">تشغيل جميع الكلمات ▶️</button>
  <button id="stop-reading-btn" disabled>إيقاف القراءة ⏹️</button>
</div>

<!-- Overlay: user must press once to enable speech on mobile browsers -->
<div id="enable-audio-overlay" aria-hidden="false">
  <div class="panel">
    <h3>تفعيل الصوت</h3>
    <p>اضغط هنا مرة واحدة لتفعيل النطق على الموبايل (مطلوب من بعض المتصفحات)</p>
    <button id="enable-audio-btn">تفعيل الصوت</button>
    <p style="font-size:.85rem;margin-top:8px;color:#666">إذا لم يعمل، جرّب فتح الملف في Google Chrome أو تحديث المتصفح.</p>
  </div>
</div>

<script>
/* ----------------------------
   Data (words + irregular verbs)
   ---------------------------- */
const words = [
  { en: "neat", ar: "منظم / مهندم", syn: "arranged / organized", ant: "messy" },
  { en: "quiet", ar: "هادئ", syn: "calm", ant: "noisy" },
  { en: "particular", ar: "معين / خاص", syn: "special / certain", ant: "general / common" },
  { en: "improve", ar: "يحسن", syn: "develop", ant: "damage" },
  { en: "understand", ar: "يفهم", syn: "know / realize", ant: "misunderstand" },
  { en: "auditory learners", ar: "متعلمين بالمؤثرات السمعية" },
  { en: "kinesthetic learners", ar: "متعلمين عن طريق الأنشطة الحركية والحسية" },
  { en: "visual learners", ar: "متعلمين بالمؤثرات البصرية" },
  { en: "hands-on activities", ar: "أنشطة تطبيقية" },
  { en: "methods / styles", ar: "طرق / وسائل" },
  { en: "techniques", ar: "تقنيات / أساليب" },
  { en: "focus", ar: "يركز" },
  { en: "avoid", ar: "يتجنب" },
  { en: "schedule", ar: "جدول أو برنامج محدد للمواعيد" },
  { en: "mind maps", ar: "خرائط ذهنية" },
  { en: "memorize", ar: "يحفظ / يتذكر (عن ظهر قلب)" },
  { en: "experiments", ar: "تجارب (علمية)" },
  { en: "passion", ar: "شغف / اهتمام" },
  { en: "suit", ar: "يناسب / يلائم" },
  { en: "learning style", ar: "أسلوب تعلم" },
  { en: "distraction", ar: "تشتيت الانتباه" },
  { en: "charts", ar: "مخططات / رسوم بيانية" },
  { en: "organize", ar: "ينظم" },
  { en: "explanation", ar: "تفسير / توضيح" },
  { en: "review", ar: "يراجع / مراجعة" },
  { en: "challenge", ar: "تحدي" },
  { en: "sight", ar: "حاسة البصر" },
  { en: "study space", ar: "مساحة مخصصة للدراسة" },
  { en: "organized", ar: "منظم / مرتب" },
  { en: "arrange", ar: "يرتب" },
  { en: "discuss", ar: "يناقش" },
  { en: "regularly", ar: "بانتظام" },
  { en: "models", ar: "نماذج" },
  { en: "physical", ar: "بدني" },
  { en: "remember", ar: "يتذكر" },
  { en: "key", ar: "مفتاح / مدخل" },
  { en: "folder", ar: "ملف / مجلد" },
  { en: "success", ar: "نجاح" },
  { en: "solutions", ar: "حلول" },
  { en: "individually", ar: "بشكل فردي" },
  { en: "competition", ar: "منافسة" },
  { en: "relax", ar: "يسترخ / يستريح" },
  { en: "research", ar: "بحث / يبحث" },
  { en: "unforgettable", ar: "لا ينسى" },
  { en: "revise", ar: "يراجع" },
  { en: "playground", ar: "ملعب" },
  { en: "enjoyable", ar: "ممتع" },
  { en: "experience", ar: "تجربة حياتية / خبرة سابقة" },
  { en: "stay focused", ar: "يظل على تركيزه" },
  { en: "solve the problems", ar: "يحل المشكلات" },
  { en: "say things out loud", ar: "يقول الأشياء بصوت عال" },
  { en: "take breaks", ar: "يأخذ فترات راحة" },
  { en: "work individually", ar: "يعمل بطريقة فردية" },
  { en: "make something better", ar: "يجعل شيئاً ما أفضل" },
  { en: "get enough sleep", ar: "يحصل على قدر كاف من النوم" },
  { en: "move around", ar: "يتحرك / يتنقل" },
  { en: "change over time", ar: "يتغير مع مرور الوقت" },
  { en: "get better", ar: "يتعافى / يتحسن" },
  { en: "take notes", ar: "يدون ملاحظات" },
  { en: "away from", ar: "بعيداً عن" },
  { en: "turn off", ar: "يفصل / يغلق جهاز" },
  { en: "related to", ar: "مرتبط بـ" },
  { en: "revise for...", ar: "يراجع لـ..." },
  { en: "at the same times", ar: "في نفس الأوقات" },
  { en: "during the learning experience", ar: "أثناء تجربة التعلم" },
  { en: "at the beginning", ar: "في البداية" },
  { en: "step by step", ar: "خطوة بخطوة" },
  { en: "get ready for", ar: "يستعد لـ" },
  { en: "in a particular order", ar: "في ترتيب محدد" },
  { en: "on the internet", ar: "على الإنترنت" },
  { en: "in a team", ar: "في فريق" },
  { en: "now", ar: "الآن" },
  { en: "Look!", ar: "انظر!" },
  { en: "Listen!", ar: "أنصت!" },
  { en: "Take care!", ar: "احذر!" },
  { en: "right now", ar: "الآن" },
  { en: "Look out! / Watch out!", ar: "احترس!" },
  { en: "at the moment", ar: "في تلك اللحظة" },
  { en: "at present", ar: "في الوقت الحاضر" },
  { en: "do experiments", ar: "يُجري تجارب علمية" },
  { en: "do hand-on activities", ar: "يقوم بعمل أنشطة تطبيقية" },
  { en: "have a problem", ar: "لديه مشكلة" },
  { en: "use an app", ar: "يستخدم تطبيق" },
  { en: "build models", ar: "يصنع / يبني نماذج" }
];

const irregularVerbs = [
  { present: "understand", past: "understood", pp: "understood" },
  { present: "draw", past: "drew", pp: "drawn" },
  { present: "do", past: "did", pp: "done" },
  { present: "build", past: "built", pp: "built" },
  { present: "choose", past: "chose", pp: "chosen" },
  { present: "become", past: "became", pp: "become" }
];

/* ----------------------------
   App state & DOM refs
   ---------------------------- */
let synth = window.speechSynthesis;
let selectedVoice = null;
let isReading = false;
let currentWordIndex = 0;
let utterance = null;
let wordElements = [];

const wordGrid = document.getElementById('word-grid');
const startAllBtn = document.getElementById('start-all-btn');
const stopReadingBtn = document.getElementById('stop-reading-btn');
const speedControl = document.getElementById('speed-control');
const enableOverlay = document.getElementById('enable-audio-overlay');
const enableBtn = document.getElementById('enable-audio-btn');

/* ----------------------------
   Helpers
   ---------------------------- */
function getIrregular(present){ return irregularVerbs.find(v=>v.present===present) || null; }

function buildAuxHTML(word){
  let html = '<div class="aux-container">';
  const v = getIrregular(word.en);
  if(word.syn) html += `<div class="aux-item synonym" data-speak="${escapeAttr(word.syn)}"><span class="aux-word">${word.syn}</span><span class="aux-label">مرادف</span></div>`;
  if(word.ant) html += `<div class="aux-item antonym" data-speak="${escapeAttr(word.ant)}"><span class="aux-word">${word.ant}</span><span class="aux-label">مضاد</span></div>`;
  if(v){
    html += `<div class="aux-item past-form" data-speak="${escapeAttr(v.past)}"><span class="aux-word">${v.past}</span><span class="aux-label">ماضي</span></div>`;
    html += `<div class="aux-item past-form" data-speak="${escapeAttr(v.pp)}"><span class="aux-word">${v.pp}</span><span class="aux-label">ت. ثالث</span></div>`;
  }
  html += '</div>';
  return html;
}
function escapeAttr(s){ return (s||'').replace(/"/g,'&quot;'); }

/* render cards */
function renderCards(){
  wordGrid.innerHTML = '';
  wordElements = [];
  words.forEach((w,i)=>{
    const card = document.createElement('div');
    card.className = 'card';
    card.dataset.index = i;
    card.innerHTML = `
      <div class="main-word-area" data-speak="${escapeAttr(w.en)}">
        <h2>${w.en}</h2>
        <p class="arabic-meaning">${w.ar}</p>
      </div>
      ${buildAuxHTML(w)}
    `;
    wordElements.push(card);
    wordGrid.appendChild(card);
  });

  // attach listeners
  document.querySelectorAll('.main-word-area, .aux-item').forEach(el=>{
    el.addEventListener('click', (e)=>{
      if(isReading) stopReading(); // stop continuous reading
      const text = el.dataset.speak;
      const card = el.closest('.card');
      speakWord(text, card, el);
      e.stopPropagation();
    });
  });
}

/* choose an English voice if possible */
function chooseVoice(){
  const voices = synth.getVoices();
  // prefer en voices
  let v = voices.find(voice => voice.lang && (voice.lang.startsWith('en') || voice.lang.toLowerCase().includes('english')));
  if(!v) v = voices[0] || null;
  selectedVoice = v;
  console.log('voices loaded:', voices.map(x=>x.lang + ' / ' + x.name).slice(0,6));
  console.log('selected voice:', selectedVoice ? selectedVoice.name + ' (' + selectedVoice.lang + ')' : 'none');
}

/* speak a single text, highlight elements while speaking */
function speakWord(text, card, el, callback){
  try {
    if(!text) return;
    if(synth.speaking) synth.cancel();
    // clear classes
    document.querySelectorAll('.card').forEach(c=>c.classList.remove('active'));
    document.querySelectorAll('.main-word-area.active, .aux-item.active').forEach(x=>x.classList.remove('active'));
    // highlight
    if(card){ card.classList.add('active'); card.scrollIntoView({behavior:'smooth',block:'center'}); }
    if(el) el.classList.add('active');

    utterance = new SpeechSynthesisUtterance(text);
    utterance.lang = 'en-US';
    utterance.rate = parseFloat(speedControl.value||1.0);
    if(selectedVoice) utterance.voice = selectedVoice;
    // safety: small volume default (1)
    utterance.volume = 1.0;

    utterance.onend = ()=>{
      if(card) card.classList.remove('active');
      if(el) el.classList.remove('active');
      if(callback) callback();
    };
    utterance.onerror = (ev)=>{
      console.error('synthesis error', ev);
      if(card) card.classList.remove('active');
      if(el) el.classList.remove('active');
      if(callback) callback();
      alert('حدث خطأ أثناء النطق. تأكد من إعدادات المتصفح أو جرّب Google Chrome.');
    };
    synth.speak(utterance);
  } catch(err){
    console.error('speakWord exception', err);
    alert('خطأ داخلي: ' + (err.message||err));
  }
}

/* Continuous reading functions */
function startReading(){
  if(isReading) return;
  isReading = true;
  currentWordIndex = 0;
  updateControls(true);
  readNext();
}
function readNext(){
  if(!isReading || currentWordIndex >= words.length){ stopReading(); return; }
  const w = words[currentWordIndex];
  const card = wordElements[currentWordIndex];
  const main = card.querySelector('.main-word-area');
  speakWord(w.en, card, main, ()=>{
    currentWordIndex++;
    // small delay between words so user can notice highlight
    setTimeout(()=>{ readNext(); }, 200);
  });
}
function stopReading(){
  if(synth.speaking) synth.cancel();
  isReading = false;
  currentWordIndex = 0;
  updateControls(false);
  document.querySelectorAll('.card.active, .main-word-area.active, .aux-item.active').forEach(e=>e.classList.remove('active'));
}
function updateControls(reading){
  startAllBtn.disabled = reading;
  stopReadingBtn.disabled = !reading;
}

/* ----------------------------
   Unlock & init (mobile-safe)
   ---------------------------- */
function unlockSpeechOnce(){
  // Attempt to speak a tiny silent utterance to unlock the engine
  try {
    const u = new SpeechSynthesisUtterance(' ');
    // choose small volume and language (some browsers ignore silent)
    u.volume = 0;
    if(selectedVoice) u.voice = selectedVoice;
    synth.speak(u);
  } catch(e){
    console.warn('unlock attempt failed', e);
  }
}

/* Event wiring & startup */
document.addEventListener('DOMContentLoaded', ()=>{

  // 1) Render cards
  renderCards();

  // 2) Prepare voices: voices may load asynchronously
  if(!('speechSynthesis' in window)){
    alert('متصفحك لا يدعم خاصية النطق الصوتي (SpeechSynthesis). جرّب Google Chrome أو متصفح أحدث.');
    // Still allow UI but no TTS
    enableOverlay.style.display = 'none';
  } else {
    // load voices; chooseVoice when available
    chooseVoice();
    window.speechSynthesis.onvoiceschanged = chooseVoice;
  }

  // 3) Attach control listeners
  document.getElementById('start-all-btn').addEventListener('click', ()=>{
    // If overlay still visible (not unlocked), encourage user to enable it first
    if(enableOverlay && enableOverlay.style.display !== 'none'){
      // show overlay instructions: user must press enable
      enableOverlay.style.display = 'flex';
      return;
    }
    startReading();
  });
  document.getElementById('stop-reading-btn').addEventListener('click', stopReading);
  speedControl.addEventListener('change', ()=>{
    // if speed changed while reading, stop for safety
    if(isReading || synth.speaking) stopReading();
  });

  // 4) Overlay button: enable audio explicitly
  enableBtn.addEventListener('click', ()=>{
    // hide overlay only after attempting unlock
    enableBtn.disabled = true;
    enableBtn.textContent = 'جاري التفعيل...';
    // choose voice again
    chooseVoice();
    // attempt to unlock
    try{
      // Speak a very short utterance: use a single space (volume 0) & then a short audible 'ok' at low volume
      // Some browsers ignore fully silent utterances; use a tiny audible beep-like syllable at very low volume if allowed.
      // First silent attempt:
      const uSilent = new SpeechSynthesisUtterance(' ');
      uSilent.volume = 0;
      if(selectedVoice) uSilent.voice = selectedVoice;
      uSilent.onend = ()=>{
        // second short audible minimal utterance (very low volume)
        const u = new SpeechSynthesisUtterance('ready');
        u.rate = 1.0;
        u.volume = 0.01; // extremely low but may be enough to unlock
        if(selectedVoice) u.voice = selectedVoice;
        u.onend = ()=>{
          enableOverlay.style.display = 'none';
          enableOverlay.setAttribute('aria-hidden','true');
          enableBtn.disabled = false;
          enableBtn.textContent = 'تفعيل الصوت';
          // mark unlocked (also attach a touchstart fallback)
          window.__TTS_UNLOCKED = true;
          console.log('TTS unlocked (button)');
        };
        u.onerror = (e)=>{
          console.warn('audible unlock failed', e);
          // still hide overlay, but inform user
          enableOverlay.style.display = 'none';
          enableOverlay.setAttribute('aria-hidden','true');
          alert('تم محاولة تفعيل الصوت — إن لم يعمل، جرّب فتح الصفحة في Google Chrome أو اضغط على زر التشغيل يدوياً.');
        };
        synth.speak(u);
      };
      uSilent.onerror = (e)=>{
        console.warn('silent unlock failed', e);
        // attempt audible short utterance regardless
        const u2 = new SpeechSynthesisUtterance('ready');
        u2.volume = 0.01;
        if(selectedVoice) u2.voice = selectedVoice;
        u2.onend = ()=>{ enableOverlay.style.display='none'; window.__TTS_UNLOCKED = true; };
        synth.speak(u2);
      };
      synth.speak(uSilent);
    } catch (err){
      console.error('unlock exception', err);
      enableOverlay.style.display = 'none';
      window.__TTS_UNLOCKED = true;
    }
  });

  // 5) Also add touchstart listener as fallback for quick unlocking
  document.addEventListener('touchstart', function onFirstTouch(){
    if(window.__TTS_UNLOCKED) return;
    try {
      chooseVoice();
      const u = new SpeechSynthesisUtterance(' ');
      u.volume = 0;
      if(selectedVoice) u.voice = selectedVoice;
      synth.speak(u);
      window.__TTS_UNLOCKED = true;
      console.log('TTS unlocked (touchstart)');
    } catch(e){
      console.warn('touchstart unlock failed', e);
    }
    document.removeEventListener('touchstart', onFirstTouch);
  }, {passive:true});

}); // DOMContentLoaded end

// optional: stop speech when leaving page
window.addEventListener('beforeunload', ()=>{
  try{ if(synth && synth.speaking) synth.cancel(); } catch(e){}
});
</script>

</body>
</html>
